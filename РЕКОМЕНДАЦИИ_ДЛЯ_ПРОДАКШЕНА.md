# üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-27  
**–ü—Ä–æ–µ–∫—Ç:** –ò–≥—Ä–∞ "–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏"  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö](#1-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ-–¥–∞–Ω–Ω—ã—Ö)
2. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#2-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
3. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#3-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
4. [–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å](#4-–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å)
5. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#5-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π](#6-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-–¥–µ–ø–ª–æ–π)
7. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#7-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API](#8-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-api)

---

## 1. –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ: –ó–∞–º–µ–Ω–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```python
# backend/app/api/routes.py:16
active_games = {}  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∏–ª–∏ –ë–î
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- ‚ùå –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∏–≥—Ä
- ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏–≥—Ä

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

#### –í–∞—Ä–∏–∞–Ω—Ç 1: Redis (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Å–µ—Å—Å–∏–π)
```python
# requirements.txt
redis>=5.0.0
hiredis>=2.2.0  # –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

# –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
import redis
import json
from datetime import timedelta

redis_client = redis.Redis(
    host=os.getenv("REDIS_HOST", "localhost"),
    port=int(os.getenv("REDIS_PORT", 6379)),
    db=0,
    decode_responses=True
)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã
def save_game(game_id: str, game_data: dict, ttl_hours: int = 24):
    redis_client.setex(
        f"game:{game_id}",
        timedelta(hours=ttl_hours),
        json.dumps(game_data)
    )

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–≥—Ä—ã
def get_game(game_id: str) -> dict:
    data = redis_client.get(f"game:{game_id}")
    return json.loads(data) if data else None
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ (TTL)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### –í–∞—Ä–∏–∞–Ω—Ç 2: PostgreSQL (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
```python
# requirements.txt
sqlalchemy>=2.0.0
asyncpg>=0.29.0  # –¥–ª—è async –ø–æ–¥–¥–µ—Ä–∂–∫–∏
alembic>=1.13.0  # –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

# –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
from sqlalchemy import Column, String, JSON, DateTime, Index
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class Game(Base):
    __tablename__ = "games"
    
    game_id = Column(String, primary_key=True)
    board = Column(JSON)
    status = Column(String)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    expires_at = Column(DateTime, index=True)
    
    __table_args__ = (
        Index('idx_expires_at', 'expires_at'),
    )
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Redis** –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä + **PostgreSQL** –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### üîµ –î–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∏–≥—Ä

```python
# –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ (—á–µ—Ä–µ–∑ Celery –∏–ª–∏ APScheduler)
from apscheduler.schedulers.asyncio import AsyncIOScheduler

async def cleanup_old_games():
    """–£–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏
    pass

scheduler = AsyncIOScheduler()
scheduler.add_job(cleanup_old_games, 'interval', hours=1)
scheduler.start()
```

---

## 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ: –ó–∞—â–∏—Ç–∞ API

#### 2.1 Rate Limiting
```python
# requirements.txt
slowapi>=0.1.9

from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

@app.post("/game/start")
@limiter.limit("10/minute")  # 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
async def start_game(request: Request):
    # ...
```

#### 2.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (Pydantic)
- üîµ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
  - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—É–∂–µ –µ—Å—Ç—å, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

#### 2.3 CORS –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```python
# backend/app/main.py
cors_origins = os.getenv(
    "CORS_ORIGINS", 
    "http://localhost:3000"
).split(",")

# –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ - —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã:
# CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

#### 2.4 HTTPS
- ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (Let's Encrypt)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reverse proxy (Nginx/Traefik)

#### 2.5 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –î–ª—è Kubernetes: Secrets
# –î–ª—è Docker: docker secrets
# –î–ª—è –æ–±–ª–∞—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–µ–∫—Ä–µ—Ç–æ–≤ (AWS Secrets Manager, etc.)
```

### üîµ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```python
# JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
from fastapi.security import HTTPBearer
from jose import jwt

security = HTTPBearer()

@app.post("/game/start")
async def start_game(token: str = Depends(security)):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    # –°–≤—è–∑—å –∏–≥—Ä—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    pass
```

---

## 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### üî¥ –ó–∞–º–µ–Ω–∏—Ç—å print –Ω–∞ logging

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```python
# backend/app/telegram/notifier.py:36
print(f"[Telegram] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
import logging

logger = logging.getLogger(__name__)

async def notify_telegram(chat_id: str, message_type: str, promocode: str = None):
    try:
        # ...
    except Exception as e:
        logger.error(
            f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram",
            extra={
                "chat_id": chat_id,
                "message_type": message_type,
                "error": str(e)
            },
            exc_info=True
        )
```

### üîµ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# requirements.txt
python-json-logger>=2.0.0

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
import logging
from pythonjsonlogger import jsonlogger

logHandler = logging.StreamHandler()
formatter = jsonlogger.JsonFormatter(
    '%(asctime)s %(name)s %(levelname)s %(message)s'
)
logHandler.setFormatter(formatter)
logger.addHandler(logHandler)
logger.setLevel(logging.INFO)
```

### üîµ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

#### Prometheus + Grafana
```python
# requirements.txt
prometheus-fastapi-instrumentator>=6.0.0

from prometheus_fastapi_instrumentator import Instrumentator

Instrumentator().instrument(app).expose(app)
```

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∏–≥—Ä
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—à–∏–±–∫–∏ API
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram

#### Health Check —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
```python
@app.get("/health")
async def health():
    checks = {
        "status": "ok",
        "timestamp": datetime.utcnow().isoformat(),
        "checks": {
            "redis": await check_redis(),
            "telegram": await check_telegram_bot(),
            "database": await check_database()  # –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        }
    }
    return checks
```

### üîµ –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤

- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (Sentry, DataDog, etc.)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

---

## 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### üî¥ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- –ù—É–∂–µ–Ω shared storage (Redis/–ë–î)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä
2. Load balancer –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
3. Stateless backend (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –∫—Ä–æ–º–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä)

### üîµ –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á

–î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
```python
# requirements.txt
celery>=5.3.0

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Celery
from celery import Celery

celery_app = Celery('tasks', broker='redis://localhost:6379/0')

@celery_app.task
def send_telegram_notification(chat_id: str, message: str):
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    pass

# –í API:
send_telegram_notification.delay(chat_id, message)  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
```

### üîµ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
from functools import lru_cache
import redis

redis_cache = redis.Redis(...)

def get_game_cached(game_id: str):
    cached = redis_cache.get(f"game:{game_id}")
    if cached:
        return json.loads(cached)
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    game = load_game_from_db(game_id)
    redis_cache.setex(f"game:{game_id}", 3600, json.dumps(game))
    return game
```

---

## 5. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### üîµ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

- ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è async/await
- üîµ –î–æ–±–∞–≤–∏—Ç—å connection pooling –¥–ª—è –ë–î
- üîµ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å AI –∞–ª–≥–æ—Ä–∏—Ç–º (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

### üîµ CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤

- –í—ã–Ω–µ—Å—Ç–∏ frontend –Ω–∞ CDN (Cloudflare, AWS CloudFront)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

### üîµ Gzip —Å–∂–∞—Ç–∏–µ

```python
from fastapi.middleware.gzip import GZipMiddleware

app.add_middleware(GZipMiddleware, minimum_size=1000)
```

---

## 6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π

### üî¥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

**Dockerfile –¥–ª—è Backend:**
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**Dockerfile –¥–ª—è Frontend:**
```dockerfile
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
```

**docker-compose.yml:**
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - TELEGRAM_BOT_URL=http://telegram-bot:8001
    depends_on:
      - redis

  telegram-bot:
    build: ./telegram-bot
    ports:
      - "8001:8001"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### üîµ Kubernetes (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- Deployments –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- Services –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- ConfigMaps –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- Secrets –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Horizontal Pod Autoscaler –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

### üîµ CI/CD Pipeline

**GitHub Actions –ø—Ä–∏–º–µ—Ä:**
```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          cd backend
          pip install -r requirements.txt
          pytest tests/ -v

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```

### üîµ Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–°–æ–∑–¥–∞—Ç—å `.env.example` —Ñ–∞–π–ª—ã:
```bash
# backend/.env.example
REDIS_HOST=localhost
REDIS_PORT=6379
TELEGRAM_BOT_URL=http://localhost:8001
CORS_ORIGINS=http://localhost:3000
DEBUG=False
LOG_LEVEL=INFO
```

---

## 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### üîµ –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

**–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
- ‚úÖ AI
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥—ã

**–î–æ–±–∞–≤–∏—Ç—å:**
- üîµ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API
- üîµ –¢–µ—Å—Ç—ã –¥–ª—è Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- üîµ –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
- üîµ E2E —Ç–µ—Å—Ç—ã –¥–ª—è frontend

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:**
```python
# tests/test_api_integration.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_full_game_flow():
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã
    response = client.post("/api/game/start")
    assert response.status_code == 200
    game_id = response.json()["game_id"]
    
    # –•–æ–¥ –∏–≥—Ä–æ–∫–∞
    response = client.post(
        "/api/game/move",
        json={"game_id": game_id, "row": 0, "col": 0}
    )
    assert response.status_code == 200
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    response = client.get(f"/api/game/{game_id}")
    assert response.status_code == 200
```

### üîµ –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å locust –∏–ª–∏ k6
# requirements.txt
locust>=2.17.0
```

---

## 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

### üîµ OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- ‚úÖ –£–∂–µ –µ—Å—Ç—å —á–µ—Ä–µ–∑ FastAPI (`/docs`, `/redoc`)
- üîµ –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –æ–ø–∏—Å–∞–Ω–∏–π –≤ —Å—Ö–µ–º—ã
- üîµ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- üîµ –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**–£–ª—É—á—à–µ–Ω–∏–µ —Å—Ö–µ–º:**
```python
from pydantic import BaseModel, Field

class MoveRequest(BaseModel):
    game_id: str = Field(..., description="ID –∏–≥—Ä—ã", example="123e4567-e89b-12d3-a456-426614174000")
    row: int = Field(..., ge=0, le=4, description="–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (0-4)", example=0)
    col: int = Field(..., ge=0, le=4, description="–ù–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ (0-4)", example=0)
    chat_id: str = Field(None, description="Telegram Chat ID –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π", example="850850290")
```

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–Ω–æ (—Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω):
1. üî¥ –ó–∞–º–µ–Ω–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –Ω–∞ Redis/–ë–î
2. üî¥ –î–æ–±–∞–≤–∏—Ç—å Rate Limiting
3. üî¥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS
4. üî¥ –ó–∞–º–µ–Ω–∏—Ç—å print –Ω–∞ logging
5. üî¥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### –í–∞–∂–Ω–æ (–≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
6. üîµ –î–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∏–≥—Ä
7. üîµ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD
8. üîµ –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
9. üîµ –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (–ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞):
10. üîµ –î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
11. üîµ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Kubernetes
12. üîµ –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (Celery)
13. üîµ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üõ†Ô∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis:**
```bash
docker run -d -p 6379:6379 redis:7-alpine
```

2. **–û–±–Ω–æ–≤–∏—Ç—å requirements.txt:**
```txt
redis>=5.0.0
slowapi>=0.1.9
prometheus-fastapi-instrumentator>=6.0.0
```

3. **–û–±–Ω–æ–≤–∏—Ç—å .env:**
```env
REDIS_HOST=localhost
REDIS_PORT=6379
CORS_ORIGINS=https://yourdomain.com
DEBUG=False
LOG_LEVEL=INFO
```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å Nginx reverse proxy:**
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [FastAPI Deployment](https://fastapi.tiangolo.com/deployment/)
- [Redis Best Practices](https://redis.io/docs/manual/patterns/)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [12 Factor App](https://12factor.net/)

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-27  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0


